#!/usr/bin/env snabb

local Intel82599 = require("apps.intel.intel_app").Intel82599
local C = require("ffi").C

local c = config.new()

config.app(c, "nic1", Intel82599, [[{pciaddr = "0000:05:00.0"}]])
config.app(c, "nic2", Intel82599, [[{pciaddr = "0000:07:00.0"}]])

config.link(c, "nic1.tx -> nic2.rx");

engine.configure(c)
buffer.preallocate(10000)

old_packets = 0

while true do

   local start = C.get_monotonic_time()

   engine.main({duration = 10})

   local finish = C.get_monotonic_time()

   local runtime = finish - start
   local packets = engine.app_table.nic1.output.tx.stats.txpackets - old_packets
   old_packets = engine.app_table.nic1.output.tx.stats.txpackets

   -- engine.report()
   print(("Processed %.1f million packets in %.2f seconds"):format(packets / 1e6, runtime))
   print(("Rate(Mpps):\t%.3f"):format(packets / runtime / 1e6))

end

